import{a as u,j as e}from"./state-Cs2e8pUQ.js";import{g,e as I,a as S,E as f}from"./index-HBtRV3iF.js";import{u as L}from"./useAlerts-BQg0lwrm.js";import{r as P,a as _,i as U,c as B,h as C,b as H,d as j,f as $}from"./downloadService-CoA7xjay.js";import{M as W,u as G,D as N}from"./downloadCatalog-Czl5oBHN.js";import{B as y}from"./Button-DadLVxJo.js";import"./vendor-D7HEtn7k.js";import"./charts-HkUfyz1_.js";const M="https://api.github.com";function D(){const t={Accept:"application/vnd.github.v3+json"};return g.VITE_GITHUB_DOWNLOAD_TOKEN&&(t.Authorization=`Bearer ${g.VITE_GITHUB_DOWNLOAD_TOKEN}`),t}function A(){return!!g.VITE_GITHUB_DOWNLOAD_TOKEN}async function F(t){if(!t.githubRepo||!t.githubPath)throw new Error("Asset does not have GitHub source configured");const c=g.VITE_GITHUB_ORG,a=t.githubBranch||"main",s=`${M}/repos/${c}/${t.githubRepo}/contents/${t.githubPath}?ref=${a}`,n=await fetch(s,{headers:D()});if(!n.ok)throw n.status===404?new Error("File not found in repository"):n.status===403?new Error("Access denied. Check GitHub token configuration."):new Error(`GitHub API error: ${n.status}`);const i=await n.json();if(i.content&&i.encoding==="base64"){const l=atob(i.content.replace(/\n/g,"")),d=new Uint8Array(l.length);for(let m=0;m<l.length;m++)d[m]=l.charCodeAt(m);return new Blob([d],{type:"application/octet-stream"})}if(i.download_url){const l=new URL(i.download_url);if(!l.hostname.endsWith("githubusercontent.com")&&!l.hostname.endsWith("github.com"))throw new Error("Unexpected download URL domain");const d=await fetch(i.download_url,{headers:D()});if(!d.ok)throw new Error(`Download failed: ${d.status}`);return d.blob()}throw new Error("Unable to download file from GitHub")}function V(t,c,a){return new Promise(s=>{const n=new FileReader;n.onload=()=>{const i=n.result,l=`# Licensed to: ${c}
# Download ID: ${a}
# Date: ${new Date().toISOString()}
# PROPRIETARY - DO NOT DISTRIBUTE

`;s(new Blob([l+i],{type:"application/octet-stream"}))},n.onerror=()=>s(t),n.readAsText(t)})}function Y(t){return t.fileType==="notebook"||t.fileType==="report"}function T(t,c){const a=URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download=c,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)}function z(){const{user:t,isAuthenticated:c}=I(),a=S(),{showInfo:s,showSuccess:n,showError:i,showWarning:l}=L(),[d,m]=u.useState(null),[p,h]=u.useState(!1),r=u.useCallback(async o=>{if(!t)return;P(t.id),_(t.id,o.assetId,o.fileName),a(f.DOWNLOAD_INITIATED,{assetId:o.assetId,fileType:o.fileType});const w=crypto.randomUUID();if(o.githubRepo&&o.githubPath&&A())try{let b=await F(o);Y(o)&&(b=await V(b,t.email,w)),T(b,o.fileName),n("Download complete",o.displayName),a(f.DOWNLOAD_COMPLETED,{assetId:o.assetId,source:"github"});return}catch{s("Using demo download","GitHub source unavailable — generating demo file.")}const O=`${`# Licensed to: ${t.email}
# Download ID: ${w}
# Date: ${new Date().toISOString()}
# PROPRIETARY - DO NOT DISTRIBUTE

`}# ${o.displayName} v${o.version}
# This is a demo download.
`,R=new Blob([O],{type:"application/octet-stream"});T(R,o.fileName),n("Download complete",o.displayName),a(f.DOWNLOAD_COMPLETED,{assetId:o.assetId,source:"demo"})},[t,a,n,s]),x=u.useCallback(o=>{if(!c||!t){l("Login Required","Please sign in to download content.");return}if(!U(t.id,o.productSlug)){i("Not Available","You need to purchase this product to download it."),a("download_blocked",{assetId:o.assetId,reason:"not_entitled"});return}if(!B(t.id)){i("Rate Limited","Too many downloads. Please try again in an hour."),a("download_blocked",{assetId:o.assetId,reason:"rate_limited"});return}if(!C(t.id)){m(o),h(!0);return}s("Starting download...",o.displayName),r(o)},[c,t,a,s,l,i,r]),v=u.useCallback(()=>{!t||!d||(H(t.id),h(!1),s("Starting download...",d.displayName),r(d),m(null))},[t,d,s,r]),E=u.useCallback(()=>{h(!1),m(null)},[]);return{download:x,showTerms:p,onAcceptTerms:v,onDeclineTerms:E}}function K({isOpen:t,onAccept:c,onDecline:a}){return e.jsx(W,{isOpen:t,onClose:a,title:"License Agreement",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"max-h-64 overflow-y-auto border border-gray-200 p-4 text-sm text-gray-600 space-y-3",children:[e.jsx("p",{className:"font-bold text-gray-900",children:"Blueprint Professional Consulting Services - Software License Agreement"}),e.jsx("p",{children:"By downloading this software, you agree to the following terms:"}),e.jsxs("p",{children:[e.jsx("strong",{children:"1. License Grant."})," BPCS grants you a non-exclusive, non-transferable license to use this software solely within your organization for internal business purposes."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"2. Restrictions."})," You may not: (a) distribute, sublicense, or transfer this software to any third party; (b) reverse engineer, decompile, or disassemble the software; (c) remove any proprietary notices or license headers; (d) use the software to build competing products."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"3. Intellectual Property."})," All intellectual property rights in the software remain with BPCS. This license does not grant you ownership of the software."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"4. Watermarking."})," Downloaded files contain embedded license information including your email address and a unique download identifier for audit purposes."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"5. Termination."})," This license terminates automatically if you violate any of these terms. Upon termination, you must destroy all copies of the software."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"6. Disclaimer."}),' THE SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED.']})]}),e.jsxs("div",{className:"flex gap-3 justify-end pt-2",children:[e.jsx(y,{variant:"secondary",onClick:a,children:"Decline"}),e.jsx(y,{onClick:c,children:"Accept & Download"})]})]})})}const k={notebook:"Jupyter Notebook",bundle:"Archive Bundle",wheel:"Python Wheel",report:"Report Template"};function ae(){const{user:t}=I(),{download:c,showTerms:a,onAcceptTerms:s,onDeclineTerms:n}=z(),{isEntitled:i}=G(),[l,d]=u.useState(()=>t?j(t.id):[]);if(!t)return null;const m=N.filter(r=>i(r.productSlug)),p=N.filter(r=>!i(r.productSlug)),h=r=>{c(r),setTimeout(()=>{d(j(t.id))},100)};return e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-12",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4",children:"Downloads"}),!A()&&e.jsxs("div",{className:"mb-6 p-3 bg-blue-50 border border-blue-200 text-blue-800 text-sm",children:[e.jsx("span",{className:"font-medium",children:"Demo Mode"})," — Real downloads available after deployment configuration."]}),m.length>0&&e.jsxs("div",{className:"mb-10",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 dark:text-gray-100 mb-4",children:"Available Downloads"}),e.jsx("div",{className:"space-y-3",children:m.map(r=>e.jsxs("div",{className:"bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 p-5 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-gray-900 dark:text-gray-100",children:r.displayName}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[k[r.fileType]||r.fileType," · v",r.version," ·"," ",$(r.sizeBytes)]})]}),e.jsx(y,{onClick:()=>h(r),children:"Download"})]},r.assetId))})]}),p.length>0&&e.jsxs("div",{className:"mb-10",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 dark:text-gray-100 mb-4",children:"Locked"}),e.jsx("div",{className:"space-y-3",children:p.map(r=>e.jsxs("div",{className:"bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-5 flex items-center justify-between opacity-60",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-gray-700 dark:text-gray-300",children:r.displayName}),e.jsxs("p",{className:"text-sm text-gray-400 dark:text-gray-400",children:[k[r.fileType]||r.fileType," · v",r.version]})]}),e.jsx("span",{className:"text-sm text-gray-400 dark:text-gray-400 font-medium",children:"Purchase Required"})]},r.assetId))})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 dark:text-gray-100 mb-4",children:"Download History"}),l.length===0?e.jsx("div",{className:"bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 p-8 text-center",children:e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No downloads yet."})}):e.jsx("div",{className:"bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900",children:[e.jsx("th",{className:"text-left px-4 py-3 font-medium text-gray-700 dark:text-gray-300",children:"File"}),e.jsx("th",{className:"text-left px-4 py-3 font-medium text-gray-700 dark:text-gray-300",children:"Date"})]})}),e.jsx("tbody",{children:l.map((r,x)=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-slate-700 last:border-0",children:[e.jsx("td",{className:"px-4 py-3 text-gray-900 dark:text-gray-100",children:r.fileName}),e.jsx("td",{className:"px-4 py-3 text-gray-500 dark:text-gray-400",children:new Date(r.downloadedAt).toLocaleString()})]},`${r.assetId}-${x}`))})]})})]}),e.jsx(K,{isOpen:a,onAccept:s,onDecline:n})]})}export{ae as default};
