import{a as r}from"./state-Cs2e8pUQ.js";import{a as f}from"./index-CJbXApFj.js";const l="blueprint_deployments",d="blueprint_dbx_connection";function C(e){try{return(JSON.parse(localStorage.getItem(l)||"{}")[e]||[]).sort((o,n)=>n.deployedAt.localeCompare(o.deployedAt))}catch{return[]}}function I(e,s){const o=JSON.parse(localStorage.getItem(l)||"{}"),n=o[e]||[];n.push(s),o[e]=n,localStorage.setItem(l,JSON.stringify(o))}function m(e){sessionStorage.setItem(d,JSON.stringify({workspaceUrl:e,connectedAt:Date.now()}))}function S(){try{const e=sessionStorage.getItem(d);return e?JSON.parse(e):null}catch{return null}}function b(){sessionStorage.removeItem(d)}function v(){const[e,s]=r.useState(()=>{const t=S();return t?{workspaceUrl:t.workspaceUrl,accessToken:"demo-token",tokenExpiry:t.connectedAt+36e5}:null}),[o,n]=r.useState(!1),a=f(),p=r.useCallback(async t=>{n(!0),a("databricks_auth_started",{workspaceUrl:t}),await new Promise(i=>setTimeout(i,1e3)),m(t),s({workspaceUrl:t,accessToken:"demo-token-"+crypto.randomUUID(),tokenExpiry:Date.now()+36e5}),a("databricks_auth_completed",{workspaceUrl:t}),n(!1)},[a]),_=r.useCallback(async t=>{const i=sessionStorage.getItem("dbx_code_verifier"),c=sessionStorage.getItem("dbx_workspace_url");if(!i||!c)throw new Error("Missing OAuth state");const g=void 0,u=await(await fetch(`${c}/oidc/v1/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:t,client_id:g,code_verifier:i,redirect_uri:`${window.location.origin}/TMP_remod_v1/auth/databricks/callback`})})).json();m(c),s({workspaceUrl:c,accessToken:u.access_token,tokenExpiry:Date.now()+u.expires_in*1e3}),sessionStorage.removeItem("dbx_code_verifier"),sessionStorage.removeItem("dbx_workspace_url"),a("databricks_auth_completed",{workspaceUrl:c})},[a]),k=r.useCallback(()=>{b(),s(null)},[]);return{connection:e,isConnected:!!e,isConnecting:o,connect:p,handleCallback:_,disconnect:k}}export{C as g,I as r,v as u};
